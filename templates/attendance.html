{% extends 'base.html' %} {% block title %}Mark Attendance{% endblock %} {%
block content %}

<!-- Attendance area start -->
<div class="tp-faq-area pt-130">
  <div class="container">
    <div class="row align-items-end">
      <div class="col-xl-7 col-lg-7 w-100">
        <div class="tp-faq-form-box">
          <div class="tp-faq-form-wrap">
            <div class="tp-faq-form-content mb-45">
              <h2>Mark Attendance</h2>

              <!-- Live Video Feed -->
              <div class="video-feed">
                <video id="video" width="640" height="480" autoplay></video>
                <p id="camera-error" style="color: red; display: none">
                  Camera not detected. Please check your camera or try a
                  different browser.
                </p>
              </div>

              <button
                id="capture-btn"
                class="tp-btn-border-paste height-50 text-center w-100 mt-4"
              >
                Capture Image from Live Feed
              </button>

              <p class="mt-3">Or</p>
            </div>

            <!-- Form to upload image -->
            <form
              id="upload-form"
              action="{{ url_for('attendance') }}"
              method="post"
              enctype="multipart/form-data"
            >
              <label for="image">Upload Image for Attendance:</label>
              <input type="file" id="image" name="image" accept="image/*" />
              <button
                type="submit"
                class="tp-btn-border-paste height-50 text-center w-100 mt-4"
              >
                Submit
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Attendance area end -->

{% if result %}
<p>{{ result }}</p>
{% endif %}

<!-- JavaScript to handle camera access -->
<script>
  async function startCamera() {
    const video = document.getElementById("video");
    const cameraError = document.getElementById("camera-error");

    try {
      // Request access to the webcam
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      // Hide the error message if the camera is accessible
      cameraError.style.display = "none";
    } catch (error) {
      // Show error message if camera access is denied or no camera is found
      video.style.display = "none";
      cameraError.style.display = "block";
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    startCamera();

    document
      .getElementById("capture-btn")
      .addEventListener("click", function (e) {
        e.preventDefault();
        const video = document.getElementById("video");

        if (!video.srcObject) {
          alert("No video feed available.");
          return;
        }

        // Create a canvas to draw the video frame
        const canvas = document.createElement("canvas");
        canvas.width = video.width;
        canvas.height = video.height;

        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Convert the canvas to an image (Blob) and send it to the server
        canvas.toBlob(function (blob) {
          const formData = new FormData();
          formData.append("image", blob, "captured.jpg");

          // Submit the captured image to the attendance route
          fetch('{{ url_for("attendance") }}', {
            method: "POST",
            body: formData,
          })
            .then((response) => response.text())
            .then((data) => {
              // Update the result area with the server response
              document
                .querySelector(".tp-faq-area")
                .insertAdjacentHTML("beforeend", `<p>${data}</p>`);
            })
            .catch((error) => console.error("Error:", error));
        }, "image/jpeg");
      });
  });
</script>

{% endblock %}
